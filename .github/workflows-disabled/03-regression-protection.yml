name: 'ğŸ›¡ï¸ Regression Protection'

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20.9.0'

jobs:
  # TEMPORARILY DISABLED DUE TO BILLING ISSUES
  regression-checks:
    name: 'ğŸ›¡ï¸ Regression Protection Checks'
    runs-on: ubuntu-latest
    if: false  # DISABLED - Remove this line when billing is resolved
    timeout-minutes: 15
    
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      - name: 'âš™ï¸ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 'ğŸ“¦ Install Dependencies'
        run: npm ci --prefer-offline --no-audit

      - name: 'ğŸ” Type Checking'
        run: npm run type-check

      - name: 'ğŸ§¹ Lint Checking'
        run: npm run lint:check

      - name: 'ğŸ§ª Unit Tests'
        run: npm test -- --run

      - name: 'ğŸ”’ Security Audit'
        run: npm run security-check

      - name: 'ğŸ“Š Build Verification'
        run: npm run build

      - name: 'ğŸ­ E2E Critical Path Tests'
        run: npx playwright test sidebar-functionality --max-failures=3

      - name: 'ğŸš« Debug Log Detection'
        run: |
          if grep -r "console\.log.*ğŸ”\|console\.log.*ğŸ“Š\|console\.log.*âœ…\|console\.log.*âŒ" src/; then
            echo "âŒ Debug logs detected in codebase!"
            echo "Run 'npm run clean-logs' to remove them."
            exit 1
          else
            echo "âœ… No debug logs detected"
          fi

      - name: 'ğŸ“ˆ Bundle Size Check'
        run: |
          npm run build
          BUNDLE_SIZE=$(du -sk dist | cut -f1)
          if [ $BUNDLE_SIZE -gt 5000 ]; then
            echo "âš ï¸ Bundle size is ${BUNDLE_SIZE}KB (threshold: 5MB)"
            echo "Consider optimizing imports and dependencies"
          else
            echo "âœ… Bundle size OK: ${BUNDLE_SIZE}KB"
          fi

  accessibility-check:
    name: 'â™¿ Accessibility Check'
    runs-on: ubuntu-latest
    needs: regression-checks
    
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      - name: 'âš™ï¸ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 'ğŸ“¦ Install Dependencies'
        run: npm ci --prefer-offline --no-audit

      - name: 'â™¿ Run Accessibility Tests'
        run: npm test tests/accessibility/ -- --run

  performance-check:
    name: 'âš¡ Performance Check'
    runs-on: ubuntu-latest
    needs: regression-checks
    
    steps:
      - name: 'ğŸ“¥ Checkout Repository'
        uses: actions/checkout@v4

      - name: 'âš™ï¸ Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 'ğŸ“¦ Install Dependencies'
        run: npm ci --prefer-offline --no-audit

      - name: 'âš¡ Run Performance Tests'
        run: npm test tests/performance/ -- --run 